'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var nSQL=require('nano-sql').nSQL;var Model=function(){function Model(attributes){_classCallCheck(this,Model);Object.defineProperty(this,'_attributes',{value:attributes,writable:true})}_createClass(Model,[{key:'save',value:function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(){var _this=this;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.constructor.db){_context.next=2;break}return _context.abrupt('return',new Promise(function(res,rej){setTimeout(function(){_this.save().then(res)},100)}));case 2:return _context.abrupt('return',new Promise(function(res,rej){nSQL(_this.table).query('upsert',_this.attributes).exec().then(function(result,db){_this.attributes=result[0].rows[0];res(_this)})}));case 3:case'end':return _context.stop();}}},_callee,this)}));function save(){return _ref.apply(this,arguments)}return save}()},{key:'getAttribute',value:function getAttribute(attr,def){if(this._attributes[attr]){return this._attributes[attr]}return def}},{key:'setAttribute',value:function setAttribute(attr,val){var copy=Object.assign({},this.attributes);var updated=false;this.schema.forEach(function(col){if(col.key==attr){copy[attr]=val;updated=true}});if(!updated){throw new Error('Attribute '+attr+' doesn\'t exist in this model ('+this.constructor.name+')')}return this.attributes=copy}},{key:'schema',get:function get(){return this.constructor.schema}},{key:'keyAttribute',get:function get(){return this.constructor.keyAttribute}},{key:'table',get:function get(){return this.constructor.table}},{key:'attributes',get:function get(){return this._attributes},set:function set(attributes){this._attributes=attributes}}],[{key:'create',value:function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(attributes){var _this2=this;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(this.db){_context2.next=2;break}return _context2.abrupt('return',new Promise(function(res,rej){setTimeout(function(){_this2.create(attributes).then(res).catch(rej)},100)}));case 2:return _context2.abrupt('return',new Promise(function(res,rej){nSQL(_this2.table).query('upsert',attributes).exec().then(function(result,db){var model=new _this2(result[0].rows[0]);res(model)})}));case 3:case'end':return _context2.stop();}}},_callee2,this)}));function create(_x){return _ref2.apply(this,arguments)}return create}()},{key:'all',value:function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(){var _this3=this;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(this.db){_context3.next=2;break}return _context3.abrupt('return',new Promise(function(res,rej){setTimeout(function(){_this3.all().then(res)},100)}));case 2:return _context3.abrupt('return',new Promise(function(res,rej){nSQL(_this3.table).query('select').exec().then(function(result,db){var models=[];result.forEach(function(result){models.push(new _this3(result))});res(models)})}));case 3:case'end':return _context3.stop();}}},_callee3,this)}));function all(){return _ref3.apply(this,arguments)}return all}()},{key:'find',value:function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(key){var _this4=this;return regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(this.db){_context4.next=2;break}return _context4.abrupt('return',new Promise(function(res,rej){setTimeout(function(){_this4.find(key).then(res).catch(rej)},100)}));case 2:return _context4.abrupt('return',new Promise(function(res,rej){nSQL(_this4.table).query('select').where([_this4.keyAttribute,'=',key]).exec().then(function(result,db){var model=new _this4(result[0]);res(model)})}));case 3:case'end':return _context4.stop();}}},_callee4,this)}));function find(_x2){return _ref4.apply(this,arguments)}return find}()},{key:'schema',get:function get(){throw new Error('Schema not declared')}},{key:'keyAttribute',get:function get(){return'id'}},{key:'table',get:function get(){return this.name.toLowerCase()}}]);return Model}();module.exports=Model;